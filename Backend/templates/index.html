<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Stock Analyst - Professional Trading Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <!-- Use Alpine v3 for better reactivity and $forceUpdate -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.1/dist/cdn.min.js" defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            font-family: 'Inter', sans-serif;
            background: #0f172a;
            overflow-x: hidden;
            height: 100%;
            width: 100%;
            position: fixed;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .chat-item.active {
            background-color: #1e293b;
            border-left: 3px solid #10b981;
        }

        [x-cloak] {
            display: none !important;
        }

        .message-user {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 18px 18px 4px 18px;
        }

        .message-agent {
            background: #1e293b;
            border-radius: 18px 18px 18px 4px;
            border: 1px solid #334155;
        }

        /* New class for clickable chart images */
        .message-chart {
            background: #1e293b;
            border-radius: 18px;
            border: 1px solid #334155;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .message-chart:hover {
            border-color: #10b981;
            transform: scale(1.02);
        }

        .message-chart img {
            border-radius: 12px;
            max-width: 100%;
            height: auto;
        }

        .message-system {
            background: #292504;
            border: 1px solid #a16207;
            color: #fefce8;
            border-radius: 18px;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message {
            animation: slideIn 0.3s ease-out;
        }

        body.auth-loading {
            visibility: hidden;
        }

        .auth-wrapper {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .auth-container {
            position: relative;
            width: 100%;
            min-height: 100vh;
            background: #1f2937;
            overflow: hidden;
        }

        @media (min-width: 768px) {
            .auth-wrapper {
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 2rem;
            }

            .auth-container {
                max-width: 900px;
                min-height: 550px;
                border-radius: 24px;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            }
        }

        .form-container {
            width: 100%;
            min-height: 100vh;
            transition: all 0.6s ease-in-out;
        }

        @media (min-width: 768px) {
            .form-container {
                position: absolute;
                top: 0;
                height: 100%;
                min-height: auto;
                width: 50%;
            }

            .sign-in-container {
                left: 0;
                z-index: 2;
            }

            .sign-up-container {
                left: 0;
                opacity: 0;
                z-index: 1;
            }

            .auth-container.right-panel-active .sign-in-container {
                transform: translateX(100%);
            }

            .auth-container.right-panel-active .sign-up-container {
                transform: translateX(100%);
                opacity: 1;
                z-index: 5;
            }
        }

        @media (max-width: 767px) {
            .sign-in-container {
                display: block;
            }

            .sign-up-container {
                display: none;
            }

            .auth-container.right-panel-active .sign-in-container {
                display: none;
            }

            .auth-container.right-panel-active .sign-up-container {
                display: block;
            }
        }

        .overlay-container {
            display: none;
        }

        @media (min-width: 768px) {
            .overlay-container {
                display: block;
                position: absolute;
                top: 0;
                left: 50%;
                width: 50%;
                height: 100%;
                overflow: hidden;
                transition: transform 0.6s ease-in-out;
                z-index: 100;
            }

            .auth-container.right-panel-active .overlay-container {
                transform: translateX(-100%);
            }

            .overlay {
                background: linear-gradient(135deg, #10b981, #059669, #047857);
                position: relative;
                left: -100%;
                height: 100%;
                width: 200%;
                transform: translateX(0);
                transition: transform 0.6s ease-in-out;
                color: #fff;
            }

            .auth-container.right-panel-active .overlay {
                transform: translateX(50%);
            }

            .overlay-panel {
                position: absolute;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-direction: column;
                padding: 0 40px;
                text-align: center;
                top: 0;
                height: 100%;
                width: 50%;
                transition: transform 0.6s ease-in-out;
            }

            .overlay-left {
                transform: translateX(-20%);
            }

            .auth-container.right-panel-active .overlay-left {
                transform: translateX(0);
            }

            .overlay-right {
                right: 0;
                transform: translateX(0);
            }

            .auth-container.right-panel-active .overlay-right {
                transform: translateX(20%);
            }
        }

        .auth-form {
            background: #1f2937;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 2rem 1.5rem;
            min-height: 100vh;
            text-align: center;
        }

        @media (min-width: 768px) {
            .auth-form {
                padding: 0 50px;
                height: 100%;
                min-height: auto;
            }
        }

        .input-focus:focus {
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .ghost-btn {
            border: 2px solid white;
            background: transparent;
            color: white;
        }

        .ghost-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .header-gradient {
            background: linear-gradient(to right, #0f172a, #1e293b);
            border-bottom: 1px solid #334155;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        @keyframes typing {

            0%,
            60%,
            100% {
                transform: translateY(0);
            }

            30% {
                transform: translateY(-10px);
            }
        }

        .typing-dot {
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            position: relative;
        }

        @media (min-width: 768px) {
            .app-container {
                flex-direction: row;
            }
        }

        .mobile-sidebar {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 280px;
            max-width: 85vw;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 50;
        }

        .mobile-sidebar.open {
            transform: translateX(0);
        }

        @media (min-width: 768px) {
            .mobile-sidebar {
                position: relative;
                transform: translateX(0) !important;
                max-width: none;
            }
        }

        .portfolio-window {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 640px;
            max-width: calc(100vw - 40px);
            height: 85vh;
            max-height: 85vh;
            background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
            border-radius: 20px;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.7), 0 0 0 1px rgba(16, 185, 129, 0.3);
            z-index: 100;
            display: flex;
            flex-direction: column;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(20px);
        }

        .portfolio-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .portfolio-window.minimized {
            height: 68px !important;
            max-height: 68px !important;
        }

        .portfolio-window.minimized .portfolio-content {
            display: none !important;
        }

        .portfolio-window.maximized {
            width: 95vw !important;
            max-width: 1200px !important;
            height: 92vh !important;
            max-height: 92vh !important;
        }

        @media (max-width: 768px) {
            .portfolio-window {
                width: calc(100vw - 20px);
                right: 10px;
                bottom: 10px;
            }

            .portfolio-window.maximized {
                width: calc(100vw - 20px) !important;
                height: 90vh !important;
            }
        }

        .portfolio-tabs button.active {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 4px 14px rgba(16, 185, 129, 0.4);
        }

        .stock-item {
            transition: all 0.2s;
        }

        .stock-item:hover {
            background: rgba(16, 185, 129, 0.1);
            transform: translateX(4px);
        }

        .stock-item.selected {
            background: rgba(16, 185, 129, 0.2);
            border-color: #10b981;
        }

        .pulse-green {
            animation: pulse-green 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse-green {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }
    </style>
    <!-- NEW: TradingView Lightweight Charts Library -->
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
</head>

<body class="bg-slate-950 text-white antialiased auth-loading" x-data="chatApp()" x-init="init()">

    <div x-show="!isLoggedIn" x-cloak
        class="fixed inset-0 bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 z-50">
        <div class="absolute inset-0 overflow-hidden pointer-events-none">
            <div class="absolute top-20 left-20 w-72 h-72 bg-green-500/10 rounded-full blur-3xl animate-pulse"></div>
            <div class="absolute bottom-20 right-20 w-96 h-96 bg-blue-500/10 rounded-full blur-3xl animate-pulse"
                style="animation-delay: 1s;"></div>
        </div>

        <div class="auth-wrapper">
            <div class="auth-container" :class="{ 'right-panel-active': isLoginView }">

                <div class="form-container sign-in-container">
                    <form @submit.prevent="handleSignup()" class="auth-form">
                        <div class="mb-6 text-center w-full">
                            <div
                                class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-green-500 to-green-700 rounded-2xl mb-4 shadow-lg">
                                <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z" />
                                </svg>
                            </div>
                            <h1 class="text-3xl font-bold text-white mb-2">Start Trading Smart</h1>
                            <p class="text-base text-gray-400">Create your free account</p>
                        </div>

                        <div class="w-full space-y-4 max-w-sm">
                            <input type="email" x-model="email" required autocomplete="email"
                                class="input-focus w-full bg-gray-700/50 text-white px-4 py-3.5 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 transition border border-gray-600"
                                placeholder="Email Address">
                            <input type="password" x-model="password" required minlength="6" autocomplete="new-password"
                                class="input-focus w-full bg-gray-700/50 text-white px-4 py-3.5 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 transition border border-gray-600"
                                placeholder="Password (min. 6 characters)">
                            <input type="password" x-model="confirmPassword" required minlength="6"
                                autocomplete="new-password"
                                class="input-focus w-full bg-gray-700/50 text-white px-4 py-3.5 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 transition border border-gray-600"
                                placeholder="Confirm Password">

                            <div x-show="authError" x-transition
                                class="text-red-400 text-sm bg-red-900/20 border border-red-800/50 p-3 rounded-xl">
                                <span x-text="authError"></span>
                            </div>

                            <button type="submit" :disabled="isLoading"
                                class="w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold py-3.5 rounded-xl transition-all duration-200 disabled:opacity-50 shadow-lg hover:shadow-xl transform hover:scale-[1.02]">
                                <span x-show="!isLoading">Create Account</span>
                                <span x-show="isLoading" class="flex items-center justify-center">
                                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white"
                                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                            stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor"
                                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                        </path>
                                    </svg>
                                    <span>Creating...</span>
                                </span>
                            </button>

                            <div class="text-center pt-2">
                                <p class="text-sm text-gray-400">
                                    Already have an account?
                                    <button type="button" @click="isLoginView = true; authError = ''"
                                        class="text-green-500 font-semibold hover:text-green-400">Login</button>
                                </p>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="form-container sign-up-container">
                    <form @submit.prevent="handleLogin()" class="auth-form">
                        <div class="mb-6 text-center w-full">
                            <div
                                class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-green-500 to-green-700 rounded-2xl mb-4 shadow-lg">
                                <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z" />
                                </svg>
                            </div>
                            <h1 class="text-3xl font-bold text-white mb-2">Welcome Back!</h1>
                            <p class="text-base text-gray-400">Login to your account</p>
                        </div>

                        <div class="w-full space-y-4 max-w-sm">
                            <input type="email" x-model="email" required autocomplete="email"
                                class="input-focus w-full bg-gray-700/50 text-white px-4 py-3.5 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 transition border border-gray-600"
                                placeholder="Email Address">
                            <input type="password" x-model="password" required autocomplete="current-password"
                                class="input-focus w-full bg-gray-700/50 text-white px-4 py-3.5 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 transition border border-gray-600"
                                placeholder="Password">

                            <div x-show="authError" x-transition
                                class="text-red-400 text-sm bg-red-900/20 border border-red-800/50 p-3 rounded-xl">
                                <span x-text="authError"></span>
                            </div>

                            <button type="submit" :disabled="isLoading"
                                class="w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold py-3.5 rounded-xl transition-all shadow-lg">
                                <span x-show="!isLoading">Login</span>
                                <span x-show="isLoading" class="flex items-center justify-center">
                                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white"
                                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                            stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor"
                                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                        </path>
                                    </svg>
                                    <span>Logging in...</span>
                                </span>
                            </button>

                            <div class="text-center pt-2">
                                <p class="text-sm text-gray-400">
                                    Don't have an account?
                                    <button type="button" @click="isLoginView = false; authError = ''"
                                        class="text-green-500 font-semibold hover:text-green-400">Sign Up</button>
                                </p>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="overlay-container">
                    <div class="overlay">
                        <div class="overlay-panel overlay-left">
                            <div class="max-w-md">
                                <h1 class="text-4xl font-bold mb-4">New Here?</h1>
                                <p class="text-lg mb-8 text-green-50">Join thousands of traders making smarter
                                    decisions</p>
                                <button type="button" @click="isLoginView = false; authError = ''"
                                    class="ghost-btn px-12 py-3 rounded-full font-semibold text-lg transition-all hover:scale-105">Sign
                                    Up</button>
                            </div>
                        </div>
                        <div class="overlay-panel overlay-right">
                            <div class="max-w-md">
                                <h1 class="text-4xl font-bold mb-4">Already a Member?</h1>
                                <p class="text-lg mb-8 text-green-50">Login to access your trading dashboard</p>
                                <button type="button" @click="isLoginView = true; authError = ''"
                                    class="ghost-btn px-12 py-3 rounded-full font-semibold text-lg transition-all hover:scale-105">Login</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div x-show="isLoggedIn" x-cloak class="app-container">
        <div x-show="mobileSidebarOpen" @click="mobileSidebarOpen = false"
            class="fixed inset-0 bg-black bg-opacity-60 z-40 md:hidden"></div>

        <aside class="mobile-sidebar bg-slate-900 flex flex-col border-r border-slate-700 transition-all duration-300"
            :class="{'open': mobileSidebarOpen, 'md:w-20': isSidebarMinimized, 'md:w-64': !isSidebarMinimized}">
            <div class="p-4 border-b border-slate-700 flex items-center justify-between h-20">
                <div class="flex items-center gap-2 min-w-0" x-show="!isSidebarMinimized">
                    <svg class="w-6 h-6 text-green-500 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z" />
                    </svg>
                    <span class="text-lg font-semibold truncate">Chats</span>
                </div>
                <div x-show="isSidebarMinimized" class="flex items-center justify-center w-full">
                    <svg class="w-6 h-6 text-green-500" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z" />
                    </svg>
                </div>
                <button @click="mobileSidebarOpen = false"
                    class="md:hidden text-slate-400 hover:text-white p-2 rounded-lg hover:bg-slate-800 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <div class="p-3">
                <button @click="startNewChat()"
                    class="w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-semibold py-3 rounded-xl transition flex items-center justify-center gap-2 shadow-lg hover:shadow-green-500/30">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M11 11V5H13V11H19V13H13V19H11V13H5V11H11Z"></path>
                    </svg>
                    <span x-show="!isSidebarMinimized">New Chat</span>
                </button>
            </div>

            <nav class="flex-1 overflow-y-auto p-2 space-y-1">
                <template x-for="chat in chatList" :key="chat.chatId">
                    <div @click="loadChat(chat.chatId)"
                        :class="{ 'active': currentChatId === chat.chatId, 'justify-center': isSidebarMinimized }"
                        class="chat-item group flex items-center p-3 rounded-lg text-sm font-medium text-slate-300 hover:bg-slate-800 cursor-pointer transition-colors duration-200">
                        <svg class="w-5 h-5 flex-shrink-0" :class="isSidebarMinimized ? '' : 'mr-3'" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z">
                            </path>
                        </svg>
                        <span class="truncate flex-1" x-text="chat.title" x-show="!isSidebarMinimized"></span>
                        <div class="flex items-center opacity-0 group-hover:opacity-100 transition-opacity"
                            x-show="!isSidebarMinimized">
                            <button @click.stop="openRenameModal(chat.chatId, chat.title)"
                                class="p-1.5 text-slate-400 hover:text-white hover:bg-slate-700 rounded" title="Rename">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path
                                        d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z">
                                    </path>
                                    <path fill-rule="evenodd"
                                        d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"
                                        clip-rule="evenodd"></path>
                                </svg>
                            </button>
                            <button @click.stop="deleteChat(chat.chatId)"
                                class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-500/10 rounded"
                                title="Delete">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd"
                                        d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"
                                        clip-rule="evenodd"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </template>
            </nav>

            <div class="p-3 border-t border-slate-700 hidden md:flex">
                <button @click="isSidebarMinimized = !isSidebarMinimized"
                    class="w-full p-3 flex items-center text-slate-400 hover:text-white hover:bg-slate-800 rounded-xl transition"
                    :class="isSidebarMinimized ? 'justify-center' : ''"
                    :title="isSidebarMinimized ? 'Expand' : 'Collapse'">
                    <svg x-show="!isSidebarMinimized" class="w-5 h-5" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7">
                        </path>
                    </svg>
                    <svg x-show="isSidebarMinimized" class="w-5 h-5" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                    <span x-show="!isSidebarMinimized" class="ml-2 text-sm font-semibold">Collapse</span>
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-slate-950 min-w-0 h-full overflow-hidden">
            <header class="header-gradient px-4 sm:px-6 py-4 flex items-center justify-between h-20 flex-shrink-0">
                <div class="flex items-center gap-2 sm:gap-4 flex-1 min-w-0">
                    <button @click="mobileSidebarOpen = true"
                        class="md:hidden text-slate-400 hover:text-white p-1.5 rounded-lg hover:bg-slate-800">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>

                    <div class="flex items-center gap-3 min-w-0 flex-1" x-show="!searchVisible"
                        x-transition:enter="transition ease-out duration-100"
                        x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
                        x-transition:leave="transition ease-in duration-75"
                        x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95">
                        <div
                            class="w-11 h-11 rounded-xl bg-gradient-to-br from-green-500 to-green-700 flex items-center justify-center shadow-lg flex-shrink-0">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z" />
                            </svg>
                        </div>
                        <div class="min-w-0 flex-1">
                            <h1 id="chat-title" class="text-lg font-bold truncate">New Chat</h1>
                            <p class="text-xs text-slate-400">AI Stock Analyst</p>
                        </div>
                    </div>

                    <div class="flex-1 min-w-0" x-show="searchVisible"
                        x-transition:enter="transition ease-out duration-100"
                        x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
                        x-transition:leave="transition ease-in duration-75"
                        x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95">
                        <div
                            class="flex items-center gap-2 bg-slate-800 border border-slate-700 rounded-xl px-3 py-1.5 w-full">
                            <svg class="w-5 h-5 text-green-500 flex-shrink-0" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            <input type="text" x-ref="searchInput" x-model="searchQuery"
                                @input.debounce.300ms="performSearch()" @keydown.enter.prevent="navigateSearch('next')"
                                @keydown.arrow-down.prevent="navigateSearch('next')"
                                @keydown.arrow-up.prevent="navigateSearch('prev')"
                                @keydown.escape.prevent="toggleSearch()" placeholder="Search in chat..."
                                class="w-full bg-transparent text-white placeholder-slate-400 focus:outline-none text-sm py-1">

                            <span x-show="searchQuery.length > 1" class="text-xs text-slate-500 flex-shrink-0"
                                x-text="searchResults.length > 0 ? `${currentSearchResultIndex + 1} of ${searchResults.length}` : '0 of 0'"></span>

                            <button @click="navigateSearch('prev')" :disabled="searchResults.length === 0"
                                class="p-1 text-slate-400 hover:text-white disabled:opacity-30 disabled:cursor-not-allowed">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M5 15l7-7 7 7"></path>
                                </svg>
                            </button>
                            <button @click="navigateSearch('next')" :disabled="searchResults.length === 0"
                                class="p-1 text-slate-400 hover:text-white disabled:opacity-30 disabled:cursor-not-allowed">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <button @click="toggleSearch()" class="p-1 text-slate-400 hover:text-white">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-2 sm:gap-3">
                    <button @click="toggleSearch()" x-show="!searchVisible"
                        class="p-2.5 rounded-xl hover:bg-slate-800 text-slate-400 hover:text-white transition"
                        title="Search Chat">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </button>

                    <button @click="openPortfolio()"
                        class="flex items-center gap-2 px-3 sm:px-5 py-2.5 rounded-xl bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 transition shadow-lg hover:shadow-green-500/30">
                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                            <path
                                d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z" />
                        </svg>
                        <span class="font-bold text-white hidden sm:inline">Portfolio</span>
                    </button>

                    <button @click="handleLogout()"
                        class="p-2.5 rounded-xl hover:bg-slate-800 text-slate-400 hover:text-white transition">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z"
                                clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </header>

            <div id="chat-window"
                class="flex-1 p-4 sm:p-6 overflow-y-auto bg-gradient-to-b from-slate-950 to-slate-900 relative">
                <div x-show="chatLoading"
                    class="absolute inset-0 bg-slate-950/80 backdrop-blur-sm flex items-center justify-center z-10"
                    x-transition>
                    <div class="flex flex-col items-center">
                        <svg class="animate-spin h-10 w-10 text-green-500" xmlns="http://www.w3.org/2000/svg"
                            fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                            </circle>
                            <path class="opacity-75" fill="currentColor"
                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                            </path>
                        </svg>
                        <p class="mt-4 text-lg text-slate-300 font-semibold">Loading Chat...</p>
                    </div>
                </div>

                <div id="message-container" class="space-y-4 max-w-4xl mx-auto"></div>
            </div>

            <footer class="bg-slate-900 p-4 shadow-inner border-t border-slate-800 flex-shrink-0">
                <form id="chat-form" @submit.prevent="sendMessage()" class="max-w-4xl mx-auto">
                    <div class="flex items-end gap-3">
                        <div
                            class="flex-1 bg-slate-800 rounded-2xl border border-slate-700 focus-within:border-green-500 transition">
                            <textarea id="message-input" rows="1" placeholder="Ask about stocks..."
                                class="w-full bg-transparent text-white placeholder-slate-400 px-5 py-3 focus:outline-none resize-none max-h-32"
                                autocomplete="off" @input="autoResize($event.target)"
                                @keydown.enter.prevent="if (!$event.shiftKey) sendMessage()"></textarea>
                        </div>
                        <button type="submit" id="send-button"
                            class="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white p-4 rounded-2xl shadow-lg hover:shadow-green-500/30">
                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M3.478 2.404a.75.75 0 0 0-.926.941l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.519 60.519 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.517 60.517 0 0 0 3.478 2.404Z" />
                            </svg>
                        </button>
                    </div>
                </form>
            </footer>
        </main>
    </div>

    <!-- Portfolio Window -->
    <div x-show="portfolioOpen" x-cloak class="portfolio-window"
        :class="{'minimized': portfolioMinimized, 'maximized': portfolioMaximized}" x-transition>

        <div
            class="bg-gradient-to-r from-green-600 via-green-700 to-emerald-600 p-4 rounded-t-[20px] flex items-center justify-between flex-shrink-0">
            <div class="flex items-center gap-3 min-w-0">
                <div
                    class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-sm flex-shrink-0">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                        <path
                            d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z" />
                    </svg>
                </div>
                <div class="min-w-0">
                    <h3 class="text-white font-bold text-lg truncate">Portfolio</h3>
                    <div class="flex items-center gap-2">
                        <button
                            @click="portfolioTab === 'portfolio' ? loadPortfolio() : (portfolioTab === 'watchlist' ? loadWatchlistPrices() : loadTradeHistory())"
                            class="p-1 -ml-1 text-green-100 hover:text-white transition" title="Reload">
                            <svg class="w-4 h-4" :class="{'animate-spin': portfolioLoading}"
                                xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.664 0l3.181-3.183m-4.991-2.691L7.985 5.644m0 0v4.992m0-4.992h4.992" />
                            </svg>
                        </button>
                        <p class="text-green-100 text-xs truncate" x-text="lastUpdatedText"></p>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-1 sm:gap-2">
                <button
                    @click="portfolioMinimized = !portfolioMinimized; if(portfolioMinimized) portfolioMaximized = false"
                    class="p-2 hover:bg-white/20 rounded-lg transition"
                    :title="portfolioMinimized ? 'Expand' : 'Minimize'">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            :d="portfolioMinimized ? 'M5 15l7-7 7 7' : 'M20 12H4'"></path>
                    </svg>
                </button>
                <button
                    @click="portfolioMaximized = !portfolioMaximized; if(portfolioMaximized) portfolioMinimized = false"
                    class="p-2 hover:bg-white/20 rounded-lg transition hidden md:block"
                    :title="portfolioMaximized ? 'Restore' : 'Maximize'">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            :d="portfolioMaximized ? 'M9 9h6v6' : 'M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4'">
                        </path>
                    </svg>
                </button>
                <button @click="portfolioOpen = false" class="p-2 hover:bg-white/20 rounded-lg transition">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- START: Portfolio Tab Content Section -->
        <div class="portfolio-content bg-gradient-to-b from-slate-900 to-slate-950">
            <!-- 1. TAB BUTTONS -->
            <div class="portfolio-tabs flex border-b border-slate-700 px-4 pt-2 gap-2">
                <!-- FIX: Added portfolioLoading = true to each click event -->
                <button @click="portfolioLoading = true; portfolioTab = 'portfolio'; loadPortfolio()"
                    :class="portfolioTab === 'portfolio' ? 'active' : 'text-slate-400 hover:text-white hover:bg-slate-800'"
                    class="px-4 sm:px-6 py-2.5 text-sm font-bold transition rounded-t-xl">
                    💼 Holdings
                </button>
                <button @click="portfolioLoading = true; portfolioTab = 'watchlist'; loadWatchlistPrices()"
                    :class="portfolioTab === 'watchlist' ? 'active' : 'text-slate-400 hover:text-white hover:bg-slate-800'"
                    class="px-4 sm:px-6 py-2.5 text-sm font-bold transition rounded-t-xl">
                    👁️ Watchlist
                </button>
                <button @click="portfolioLoading = true; portfolioTab = 'history'; loadTradeHistory()"
                    :class="portfolioTab === 'history' ? 'active' : 'text-slate-400 hover:text-white hover:bg-slate-800'"
                    class="px-4 sm:px-6 py-2.5 text-sm font-bold transition rounded-t-xl">
                    📜 History
                </button>
            </div>

            <!-- 2. TAB CONTENT WRAPPER (This is the critical fix for mixed content) -->
            <div class="relative flex-1 overflow-hidden">

                <!-- 2a. Holdings Content (Now with absolute positioning) -->
                <div x-show="portfolioTab === 'portfolio'" class="absolute inset-0 overflow-y-auto p-4" x-transition>

                    <!-- Loading Skeleton -->
                    <div x-show="portfolioLoading" class="animate-pulse">
                        <div class="space-y-3 mb-4">
                            <div class="bg-slate-800 h-24 rounded-xl col-span-2"></div>
                            <div class="grid grid-cols-3 gap-3">
                                <div class="bg-slate-800 h-24 rounded-xl"></div>
                                <div class="bg-slate-800 h-24 rounded-xl"></div>
                                <div class="bg-slate-800 h-24 rounded-xl"></div>
                            </div>
                        </div>
                        <div class="bg-slate-800 h-12 rounded-xl mb-4"></div>
                        <div class="space-y-3">
                            <div class="bg-slate-800 h-32 rounded-xl"></div>
                            <div class="bg-slate-800 h-32 rounded-xl"></div>
                        </div>
                    </div>

                    <!-- Real Data -->
                    <div x-show="!portfolioLoading">
                        <div class="space-y-3 mb-4">
                            <!-- Row 1: Total Portfolio Value -->
                            <div
                                class="bg-gradient-to-br from-blue-800 to-blue-900 p-4 rounded-xl border border-blue-700 shadow-lg">
                                <div class="flex items-center gap-2 mb-2">
                                    <div class="w-8 h-8 bg-blue-500/20 rounded-lg flex items-center justify-center">
                                        <svg class="w-4 h-4 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                                            <path
                                                d="M10 2a4 4 0 00-4 4v1H5a1 1 0 00-.993.883L4 8v9a2 2 0 002 2h8a2 2 0 002-2V8l-.007-.117A1 1 0 0015 7h-1V6a4 4 0 00-4-4zm-2 5V6a2 2 0 114 0v1H8z">
                                            </path>
                                        </svg>
                                    </div>
                                    <p class="text-xs text-slate-300 font-semibold">Total Portfolio Value</p>
                                </div>
                                <p class="text-3xl font-bold text-white"
                                    x-text="'₹' + (portfolio.summary?.portfolio_value || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})">
                                </p>
                            </div>
                            <!-- Row 2: Three-column grid -->
                            <div class="grid grid-cols-3 gap-3">
                                <!-- Cash Balance -->
                                <div
                                    class="bg-gradient-to-br from-slate-800 to-slate-900 p-4 rounded-xl border border-slate-700 shadow-lg flex flex-col h-full justify-between">
                                    <div class="flex justify-between items-center mb-2">
                                        <p class="text-xs text-slate-400 font-semibold">Cash Balance</p>
                                        <button @click="openCashEditModal()"
                                            class="p-1.5 text-slate-500 hover:text-green-500 hover:bg-slate-700 rounded-lg transition"
                                            title="Edit Cash">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                <path
                                                    d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z">
                                                </path>
                                                <path fill-rule="evenodd"
                                                    d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"
                                                    clip-rule="evenodd"></path>
                                            </svg>
                                        </button>
                                    </div>
                                    <p class="text-xl font-bold text-green-500"
                                        x-text="'₹' + (portfolio.cash || 0).toLocaleString('en-IN')"></p>
                                </div>

                                <!-- Total P&L with Percentage -->
                                <div
                                    class="bg-gradient-to-br from-slate-800 to-slate-900 p-4 rounded-xl border border-slate-700 shadow-lg flex flex-col h-full justify-between">
                                    <p class="text-xs text-slate-400 font-semibold mb-2">Total P&L</p>
                                    <div class="flex flex-col">
                                        <p class="text-xl font-bold"
                                            :class="(portfolio.summary?.total_pnl || 0) >= 0 ? 'text-green-500' : 'text-red-500'"
                                            x-text="((portfolio.summary?.total_pnl || 0) >= 0 ? '+' : '') + '₹' + (portfolio.summary?.total_pnl || 0).toLocaleString('en-IN')">
                                        </p>
                                        <p class="text-sm mt-1"
                                            :class="(portfolio.summary?.total_pnl || 0) >= 0 ? 'text-green-400' : 'text-red-400'"
                                            x-show="portfolio.summary?.total_pnl_percent !== undefined"
                                            x-text="((portfolio.summary?.total_pnl_percent || 0) >= 0 ? '+' : '') + (portfolio.summary?.total_pnl_percent || 0).toFixed(2) + '%'">
                                        </p>
                                    </div>
                                </div>

                                <!-- Today's P&L with Percentage -->
                                <div
                                    class="bg-gradient-to-br from-slate-800 to-slate-900 p-4 rounded-xl border border-slate-700 shadow-lg flex flex-col h-full justify-between">
                                    <p class="text-xs text-slate-400 font-semibold mb-2">Today's P&L</p>
                                    <div class="flex flex-col">
                                        <p class="text-xl font-bold"
                                            :class="(portfolio.summary?.day_pnl || 0) >= 0 ? 'text-green-500' : 'text-red-500'"
                                            x-text="((portfolio.summary?.day_pnl || 0) >= 0 ? '+' : '') + '₹' + (portfolio.summary?.day_pnl || 0).toLocaleString('en-IN')">
                                        </p>
                                        <p class="text-sm mt-1"
                                            :class="(portfolio.summary?.day_pnl || 0) >= 0 ? 'text-green-400' : 'text-red-400'"
                                            x-show="portfolio.summary?.day_pnl_percent !== undefined"
                                            x-text="((portfolio.summary?.day_pnl_percent || 0) >= 0 ? '+' : '') + (portfolio.summary?.day_pnl_percent || 0).toFixed(2) + '%'">
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- New Trade Button -->
                        <button @click="openStockPicker('trade')"
                            class="w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold py-3.5 rounded-xl transition mb-4 shadow-lg hover:shadow-green-500/30 transform hover:scale-[1.02]">
                            <div class="flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd"
                                        d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z"
                                        clip-rule="evenodd"></path>
                                </svg>
                                <span>New Trade</span>
                            </div>
                        </button>

                        <!-- Holdings List -->
                        <div class="space-y-3">
                            <!-- Empty Holdings Message -->
                            <div x-show="!portfolio.holdings || portfolio.holdings.length === 0"
                                class="text-center py-12">
                                <div
                                    class="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <svg class="w-10 h-10 text-slate-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                        <path fill-rule="evenodd"
                                            d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z"
                                            clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <p class="text-slate-400 font-semibold">No holdings yet</p>
                                <p class="text-slate-500 text-sm mt-1">Start trading to build your portfolio</p>
                            </div>

                            <!-- Holdings Loop -->
                            <template x-for="holding in portfolio.holdings" :key="holding.ticker">
                                <div
                                    class="bg-gradient-to-br from-slate-800 to-slate-900 p-4 rounded-xl border border-slate-700 shadow-lg hover:shadow-xl hover:border-slate-600 transition-all">
                                    <div class="flex justify-between items-start mb-3">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2 mb-1">
                                                <h4 class="font-bold text-white" x-text="holding.ticker"></h4>
                                                <span class="px-2 py-0.5 bg-slate-700 rounded text-xs text-slate-300"
                                                    x-text="holding.quantity + ' shares'"></span>
                                            </div>
                                            <p class="text-xs text-slate-400">Avg: ₹<span
                                                    x-text="holding.avg_price"></span>
                                            </p>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-bold text-lg text-white">₹<span
                                                    x-text="holding.current_price"></span></p>
                                            <!-- Total P&L % -->
                                            <div class="flex items-center gap-1 justify-end">
                                                <svg class="w-4 h-4"
                                                    :class="holding.pnl >= 0 ? 'text-green-500' : 'text-red-500'"
                                                    fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd"
                                                        :d="holding.pnl >= 0 ? 'M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z' : 'M14.707 10.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 12.586V5a1 1 0 012 0v7.586l2.293-2.293a1 1 0 011.414 0z'"
                                                        clip-rule="evenodd"></path>
                                                </svg>
                                                <p class="text-sm font-bold"
                                                    :class="holding.pnl >= 0 ? 'text-green-500' : 'text-red-500'">
                                                    <span
                                                        x-text="(holding.pnl >= 0 ? '+' : '') + holding.pnl_percent.toFixed(2) + '%'"></span>
                                                </p>
                                            </div>
                                            <!-- Day's P&L % -->
                                            <div class="flex items-center gap-1 justify-end text-xs"
                                                :class="holding.approx_day_pnl >= 0 ? 'text-green-500' : 'text-red-500'">
                                                <span>Day:</span>
                                                <span
                                                    x-text="(holding.approx_day_pnl >= 0 ? '+' : '') + holding.approx_day_pnl_pct.toFixed(2) + '%'"></span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- TOTAL VALUE / INVESTED / P&L GRID -->
                                    <div
                                        class="grid grid-cols-2 gap-4 text-xs text-slate-400 mb-3 pb-3 border-b border-slate-700">

                                        <div class="text-left flex gap-4">
                                            <div>
                                                <span>Invested</span>
                                                <p class="font-semibold text-white">₹<span
                                                        x-text="holding.invested_value.toLocaleString('en-IN')"></span>
                                                </p>
                                            </div>
                                            <div>
                                                <span>Current Value</span>
                                                <p class="font-semibold text-white">₹<span
                                                        x-text="holding.current_value.toLocaleString('en-IN')"></span>
                                                </p>
                                            </div>
                                        </div>

                                        <div class="text-right">
                                            <span>Total P&L</span>
                                            <p class="font-semibold"
                                                :class="holding.pnl >= 0 ? 'text-green-500' : 'text-red-500'">
                                                <span
                                                    x-text="(holding.pnl >= 0 ? '+' : '') + '₹' + (holding.pnl).toLocaleString('en-IN')"></span>
                                            </p>
                                        </div>
                                    </div>
                                    <button @click="openTradeModal('SELL', holding.ticker, holding.quantity)"
                                        class="w-full bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white text-sm font-bold py-2.5 rounded-lg transition transform hover:scale-[1.02]">
                                        Sell All
                                    </button>
                                </div>
                            </template>
                        </div>
                    </div>

                </div>

                <!-- 2b. Watchlist Content (Now with absolute positioning) -->
                <div x-show="portfolioTab === 'watchlist'" class="absolute inset-0 overflow-y-auto p-4" x-transition>
                    <button @click="openStockPicker('watchlist')"
                        class="w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold py-3.5 rounded-xl transition mb-4 shadow-lg hover:shadow-green-500/30 transform hover:scale-[1.02]">
                        <div class="flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path>
                                <path fill-rule="evenodd"
                                    d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z"
                                    clip-rule="evenodd"></path>
                            </svg>
                            <span>Add to Watchlist</span>
                        </div>
                    </button>

                    <div x-show="watchlist.length === 0" class="text-center py-12">
                        <div class="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-10 h-10 text-slate-600" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path>
                                <path fill-rule="evenodd"
                                    d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z"
                                    clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <p class="text-slate-400 font-semibold">Your watchlist is empty</p>
                        <p class="text-slate-500 text-sm mt-1">Add stocks to track their performance</p>
                    </div>

                    <div class="space-y-3">
                        <template x-for="stock in watchlist" :key="stock.ticker">
                            <div
                                class="bg-gradient-to-br from-slate-800 to-slate-900 p-4 rounded-xl border border-slate-700 hover:border-slate-600 transition-all shadow-lg">
                                <div class="flex items-start justify-between mb-3">
                                    <div class="flex-1">
                                        <h4 class="font-bold text-white text-lg mb-1" x-text="stock.ticker"></h4>
                                        <p class="text-xs text-slate-400" x-text="getCompanyName(stock.ticker)"></p>
                                    </div>
                                    <button @click="removeFromWatchlist(stock.ticker)"
                                        class="text-red-400 hover:text-red-500 p-2 hover:bg-red-500/10 rounded-lg transition">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd"
                                                d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"
                                                clip-rule="evenodd"></path>
                                        </svg>
                                    </button>
                                </div>

                                <div class="grid grid-cols-3 gap-3 text-sm">
                                    <div class="bg-slate-700/30 p-2 rounded-lg">
                                        <p class="text-xs text-slate-400 mb-1">Current Price</p>
                                        <p class="font-bold text-white">₹<span x-text="stock.price || '-'"></span></p>
                                    </div>
                                    <div class="bg-slate-700/30 p-2 rounded-lg">
                                        <p class="text-xs text-slate-400 mb-1">Today's Change</p>
                                        <p class="font-bold"
                                            :class="stock.change >= 0 ? 'text-green-500' : 'text-red-500'"
                                            x-text="stock.change ? ((stock.change >= 0 ? '+' : '') + stock.change.toFixed(2) + '%') : '-'">
                                        </p>
                                    </div>
                                    <div class="bg-slate-700/30 p-2 rounded-lg">
                                        <p class="text-xs text-slate-400 mb-1">Day Range</p>
                                        <p class="font-bold text-white text-xs" x-text="stock.dayRange || '-'"></p>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- 2c. History Content (Now with absolute positioning) -->
                <div x-show="portfolioTab === 'history'" class="absolute inset-0 overflow-y-auto p-4" x-transition>

                    <div x-show="portfolioLoading" class="animate-pulse space-y-3">
                        <div class="bg-slate-800 h-16 rounded-xl"></div>
                        <div class="bg-slate-800 h-16 rounded-xl"></div>
                        <div class="bg-slate-800 h-16 rounded-xl"></div>
                        <div class="bg-slate-800 h-16 rounded-xl"></div>
                    </div>

                    <div x-show="!portfolioLoading && tradeHistory.length === 0" class="text-center py-12">
                        <div class="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-10 h-10 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                </path>
                            </svg>
                        </div>
                        <p class="text-slate-400 font-semibold">No trade history</p>
                        <p class="text-slate-500 text-sm mt-1">Your executed trades will appear here.</p>
                    </div>

                    <div x-show="!portfolioLoading && tradeHistory.length > 0" class="space-y-3">
                        <template x-for="trade in tradeHistory" :key="trade.timestamp">
                            <div
                                class="bg-slate-800/50 p-3 rounded-xl border border-slate-700 flex items-center justify-between gap-4">
                                <div class="flex items-center gap-3 flex-1 min-w-0">
                                    <div class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0"
                                        :class="trade.action === 'BUY' ? 'bg-green-500/20' : 'bg-red-500/20'">
                                        <svg x-show="trade.action === 'BUY'" class="w-5 h-5 text-green-400" fill="none"
                                            stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M12 4v16m8-8H4"></path>
                                        </svg>
                                        <svg x-show="trade.action === 'SELL'" class="w-5 h-5 text-red-400" fill="none"
                                            stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M18 12H6"></path>
                                        </svg>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="font-bold text-white truncate"><span x-text="trade.action"></span>
                                            <span x-text="trade.ticker"></span>
                                        </p>
                                        <p class="text-xs text-slate-400"
                                            x-text="formatTradeTimestamp(trade.timestamp)">
                                        </p>
                                    </div>
                                </div>
                                <div class="text-right flex-shrink-0">
                                    <p class="font-semibold text-white">₹<span
                                            x-text="trade.total_value.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})"></span>
                                    </p>
                                    <p class="text-xs text-slate-400"><span x-text="trade.quantity"></span> @ ₹<span
                                            x-text="trade.price.toFixed(2)"></span></p>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

            </div>
        </div>
    </div>
    <!-- END Portfolio Window -->

    <!-- START: Cash Edit Modal -->
    <div x-show="cashEditModalOpen" x-cloak @click.self="cashEditModalOpen = false"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[120] flex items-center justify-center p-4">
        <div
            class="bg-gradient-to-br from-slate-900 to-slate-950 rounded-3xl border-2 border-green-500/30 w-full max-w-md p-6 shadow-2xl">
            <h3 class="text-2xl font-bold text-white mb-4">Adjust Cash Balance</h3>
            <p class="text-slate-400 text-sm mb-6">Set your paper trading cash balance (max ₹10,00,000)</p>

            <input type="number" x-model.number="newCashAmount" min="0" max="1000000" step="1000"
                class="w-full bg-slate-800 text-white px-5 py-4 rounded-xl text-lg font-bold focus:outline-none focus:ring-2 focus:ring-green-500 border border-slate-700 mb-4"
                placeholder="Enter amount">

            <div class="flex gap-2 mb-6">
                <button @click="newCashAmount = 100000"
                    class="flex-1 bg-slate-800 hover:bg-slate-700 text-white py-2 rounded-lg text-sm">₹1L</button>
                <button @click="newCashAmount = 500000"
                    class="flex-1 bg-slate-800 hover:bg-slate-700 text-white py-2 rounded-lg text-sm">₹5L</button>
                <button @click="newCashAmount = 1000000"
                    class="flex-1 bg-slate-800 hover:bg-slate-700 text-white py-2 rounded-lg text-sm">₹10L</button>
            </div>

            <div class="flex gap-3">
                <button @click="cashEditModalOpen = false"
                    class="flex-1 bg-slate-800 hover:bg-slate-700 text-white font-bold py-3 rounded-xl">Cancel</button>
                <button @click="adjustCash()"
                    class="flex-1 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold py-3 rounded-xl">Save</button>
            </div>
        </div>
    </div>
    <!-- END: Cash Edit Modal -->

    <!-- START: Stock Picker Modal -->
    <div x-show="stockPickerOpen" x-cloak @click.self="stockPickerOpen = false"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[110] flex items-center justify-center p-4">
        <div
            class="bg-gradient-to-br from-slate-900 to-slate-950 rounded-3xl border-2 border-green-500/30 max-w-2xl w-full max-h-[85vh] flex flex-col shadow-2xl">
            <div class="bg-gradient-to-r from-green-600 to-green-700 p-6 rounded-t-3xl">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-sm">
                            <svg class="w-7 h-7 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 0l-2 2a1 1 0 101.414 1.414L8 10.414l1.293 1.293a1 1 0 001.414 0l4-4z"
                                    clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-white">
                                <span x-show="stockPickerMode === 'trade'">Select Stock</span>
                                <span x-show="stockPickerMode === 'watchlist'">Add to Watchlist</span>
                            </h3>
                            <p class="text-green-100 text-sm">
                                <span x-show="stockPickerMode === 'trade'">Choose one stock to trade</span>
                                <span x-show="stockPickerMode === 'watchlist'">Select multiple stocks</span>
                            </p>
                        </div>
                    </div>
                    <button @click="stockPickerOpen = false" class="p-2 hover:bg-white/20 rounded-xl transition">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="relative mb-4">
                    <input type="text" x-model="stockSearch" @input.debounce.300ms="filterStocks()"
                        placeholder="Search stocks..."
                        class="w-full bg-white/10 backdrop-blur-sm text-white placeholder-green-200/60 px-5 py-3.5 pl-12 rounded-xl focus:outline-none focus:ring-2 focus:ring-white/30 border border-white/20 font-medium">
                    <svg class="w-5 h-5 text-green-200 absolute left-4 top-1/2 -translate-y-1/2" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>

                <div x-show="stockPickerMode === 'watchlist' && selectedStocks.length > 0"
                    class="bg-white/10 backdrop-blur-sm px-4 py-2 rounded-xl border border-white/20">
                    <p class="text-white font-semibold text-sm">
                        <span x-text="selectedStocks.length"></span> stocks selected
                    </p>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <template x-for="stock in filteredStocks" :key="stock">
                        <button @click="toggleStockSelection(stock)"
                            :class="isStockSelected(stock) ? 'selected border-green-500 bg-green-500/10' : 'border-slate-700 hover:border-slate-600'"
                            class="stock-item p-4 bg-slate-800/50 backdrop-blur-sm rounded-xl border-2 transition-all text-left relative">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <p class="font-bold text-white text-lg" x-text="stock"></p>
                                    <p class="text-xs text-slate-400" x-text="getCompanyName(stock)"></p>
                                </div>
                                <div x-show="isStockSelected(stock)"
                                    class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd"
                                            d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                            clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                            </div>
                        </button>
                    </template>
                </div>

                <div x-show="filteredStocks.length === 0" class="text-center py-12">
                    <svg class="w-16 h-16 text-slate-600 mx-auto mb-4" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                        </path>
                    </svg>
                    <p class="text-slate-400">No stocks found</p>
                </div>
            </div>

            <div class="p-6 border-t border-slate-700 bg-slate-900/50 backdrop-blur-sm rounded-b-3xl space-y-3">
                <button x-show="stockPickerMode === 'watchlist' && selectedStocks.length > 0"
                    @click="selectedStocks = []"
                    class="w-full text-slate-400 hover:text-white font-semibold py-2 rounded-xl hover:bg-slate-800 transition text-sm">
                    Clear Selection
                </button>

                <button @click="proceedWithSelection()"
                    :disabled="stockPickerMode === 'trade' ? !selectedStock : selectedStocks.length === 0"
                    class="w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 disabled:from-slate-700 disabled:to-slate-800 text-white font-bold py-4 rounded-xl transition-all shadow-lg disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-[1.02]">
                    <span x-show="stockPickerMode === 'trade' && selectedStock">Continue with <span
                            x-text="selectedStock"></span></span>
                    <span x-show="stockPickerMode === 'trade' && !selectedStock">Select a stock to continue</span>
                    <span x-show="stockPickerMode === 'watchlist' && selectedStocks.length > 0">Add <span
                            x-text="selectedStocks.length"></span> stocks</span>
                    <span x-show="stockPickerMode === 'watchlist' && selectedStocks.length === 0">Select stocks to
                        add</span>
                </button>
            </div>
        </div>
    </div>
    <!-- END: Stock Picker Modal -->

    <!-- START: Trade Modal -->
    <div x-show="tradeModalOpen" x-cloak @click.self="tradeModalOpen = false"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[120] flex items-center justify-center p-4">
        <div
            class="bg-gradient-to-br from-slate-900 to-slate-950 rounded-3xl border-2 border-slate-700 w-full max-w-md max-h-[90vh] flex flex-col shadow-2xl overflow-hidden">
            <div class="p-6 border-b border-slate-700">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-2xl font-bold text-white"
                            x-text="tradeAction === 'BUY' ? 'Buy Stock' : 'Sell Stock'"></h3>
                        <p class="text-slate-400 text-sm mt-1" x-text="tradeTicker"></p>
                    </div>
                    <button @click="tradeModalOpen = false"
                        class="text-slate-400 hover:text-white p-2 hover:bg-slate-800 rounded-xl transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto">
                <form @submit.prevent="executeTrade()" class="p-6 space-y-4">
                    <div class="flex gap-2 p-1.5 bg-slate-800/50 rounded-xl">
                        <button type="button" @click="tradeAction = 'BUY'; calculateTradeValue()"
                            :class="tradeAction === 'BUY' ? 'bg-gradient-to-r from-green-600 to-green-700 text-white shadow-lg' : 'text-slate-400 hover:text-white'"
                            class="flex-1 py-3 rounded-lg font-bold transition-all">
                            Buy
                        </button>
                        <button type="button" @click="tradeAction = 'SELL'; calculateTradeValue()"
                            :class="tradeAction === 'SELL' ? 'bg-gradient-to-r from-red-600 to-red-700 text-white shadow-lg' : 'text-slate-400 hover:text-white'"
                            class="flex-1 py-3 rounded-lg font-bold transition-all">
                            Sell
                        </button>
                    </div>

                    <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-4 rounded-xl border border-slate-700">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-xs text-slate-400 mb-1">Current Price</p>
                                <div x-show="!loadingPrice">
                                    <p class="text-xl font-bold text-white">₹<span
                                            x-text="currentStockPrice.toFixed(2)"></span></p>
                                </div>
                                <div x-show="loadingPrice" class="h-7 w-24 bg-slate-700 animate-pulse rounded"></div>
                            </div>
                            <div>
                                <p class="text-xs text-slate-400 mb-1">Your Balance</p>
                                <p class="text-xl font-bold text-green-500">₹<span
                                        x-text="portfolio.cash.toLocaleString('en-IN')"></span></p>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-slate-300 mb-2">Quantity (shares)</label>
                        <input type="number" x-model.number="tradeQuantity"
                            @input.debounce.300ms="calculateTradeValue()" min="1" placeholder="Number of shares"
                            required
                            class="w-full bg-slate-800/50 text-white px-5 py-4 rounded-xl text-lg font-semibold focus:outline-none focus:ring-2 focus:ring-green-500 border border-slate-700">
                    </div>

                    <div
                        class="bg-gradient-to-br from-blue-900/20 to-purple-900/20 p-4 rounded-xl border border-blue-700/30">
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-slate-300">Shares</span>
                                <span class="text-lg font-bold text-white" x-text="tradeQuantity || 0"></span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-slate-300">Price per share</span>
                                <span class="text-lg font-bold text-white">₹<span
                                        x-text="currentStockPrice.toFixed(2)"></span></span>
                            </div>
                            <div class="h-px bg-slate-700"></div>
                            <div class="flex justify-between items-center">
                                <span class="text-base font-semibold text-slate-200">Total Amount</span>
                                <span class="text-2xl font-bold"
                                    :class="tradeAction === 'BUY' ? 'text-red-400' : 'text-green-400'">
                                    ₹<span x-text="totalTradeValue.toLocaleString('en-IN')"></span>
                                </span>
                            </div>

                            <div x-show="tradeAction === 'BUY'" class="flex items-center gap-2 p-2 rounded-lg"
                                :class="totalTradeValue <= portfolio.cash ? 'bg-green-500/10 border border-green-500/30' : 'bg-red-500/10 border border-red-500/30'">
                                <svg class="w-5 h-5"
                                    :class="totalTradeValue <= portfolio.cash ? 'text-green-500' : 'text-red-500'"
                                    fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd"
                                        :d="totalTradeValue <= portfolio.cash ? 'M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z' : 'M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z'"
                                        clip-rule="evenodd"></path>
                                </svg>
                                <span class="text-sm font-semibold"
                                    :class="totalTradeValue <= portfolio.cash ? 'text-green-500' : 'text-red-500'">
                                    <span x-show="totalTradeValue <= portfolio.cash">Sufficient balance</span>
                                    <span x-show="totalTradeValue > portfolio.cash">Short by ₹<span
                                            x-text="(totalTradeValue - portfolio.cash).toLocaleString('en-IN')"></span></span>
                                </span>
                            </div>
                        </div>
                    </div>

                    <div x-show="tradeError" x-transition
                        class="bg-red-900/30 border-2 border-red-700 text-red-400 px-4 py-3 rounded-xl text-sm flex items-start gap-3">
                        <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                                clip-rule="evenodd" />
                        </svg>
                        <span x-text="tradeError"></span>
                    </div>

                    <button type="submit"
                        :disabled="tradeLoading || (tradeAction === 'BUY' && totalTradeValue > portfolio.cash)"
                        :class="tradeAction === 'BUY' ? 'bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800' : 'bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800'"
                        class="w-full text-white font-bold py-4 rounded-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg transform hover:scale-[1.02]">
                        <span x-show="!tradeLoading"
                            x-text="tradeAction === 'BUY' ? '✅ Confirm Buy ₹' + totalTradeValue.toLocaleString('en-IN') : '✅ Confirm Sell ₹' + totalTradeValue.toLocaleString('en-IN')"></span>
                        <span x-show="tradeLoading" class="flex items-center justify-center">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg"
                                fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                </path>
                            </svg>
                            <span>Processing...</span>
                        </span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div x-show="renameModalOpen" x-cloak @keydown.escape.window="renameModalOpen = false"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[120] flex items-center justify-center p-4">
        <div @click.outside="renameModalOpen = false"
            class="bg-gradient-to-br from-slate-900 to-slate-950 rounded-3xl border-2 border-green-500/30 w-full max-w-md p-6 shadow-2xl">
            <h3 class="text-2xl font-bold text-white mb-4">Rename Chat</h3>
            <p class="text-slate-400 text-sm mb-6">Enter a new name for your chat session below.</p>

            <form @submit.prevent="submitRename()">
                <input type="text" x-model="newChatTitle" x-ref="renameInput"
                    class="w-full bg-slate-800 text-white px-5 py-4 rounded-xl text-lg font-bold focus:outline-none focus:ring-2 focus:ring-green-500 border border-slate-700 mb-6"
                    placeholder="New chat name" required>

                <div class="flex gap-3">
                    <button type="button" @click="renameModalOpen = false"
                        class="flex-1 bg-slate-800 hover:bg-slate-700 text-white font-bold py-3 rounded-xl transition">Cancel</button>
                    <button type="submit"
                        class="flex-1 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold py-3 rounded-xl transition">Save</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getAnalytics, logEvent } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD-HqkasonUQ5VMgmbUa7MLa0nGEeZYUP0",
            authDomain: "gen-lang-client-0593733264.firebaseapp.com",
            projectId: "gen-lang-client-0593733264",
            storageBucket: "gen-lang-client-0593733264.appspot.com",
            messagingSenderId: "774764824527",
            appId: "1:774764824527:web:ae76ef456f79c9845734ba",
            measurementId: "G-YM7GK1DBMC"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const analytics = getAnalytics(app);

        window.firebaseAuth = auth;
        window.firebaseAnalytics = analytics;
        window.firebaseAuthFunctions = { createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence };
        window.logAnalyticsEvent = (eventName, params) => logEvent(analytics, eventName, params);
    </script>

    <script>
        const API_BASE_URL = "http://127.0.0.1:8080";

        // --- Static Data (Defined globally for scope access) ---
        const NIFTY_50_STOCKS_GLOBAL = ['RELIANCE.NS', 'TCS.NS', 'HDFCBANK.NS', 'ICICIBANK.NS', 'INFY.NS', 'HINDUNILVR.NS', 'BHARTIARTL.NS', 'ITC.NS', 'SBIN.NS', 'LICI.NS', 'HCLTECH.NS', 'KOTAKBANK.NS', 'LT.NS', 'BAJFINANCE.NS', 'AXISBANK.NS', 'ASIANPAINT.NS', 'MARUTI.NS', 'SUNPHARMA.NS', 'TITAN.NS', 'WIPRO.NS', 'ULTRACEMCO.NS', 'ADANIENT.NS', 'ONGC.NS', 'NTPC.NS', 'JSWSTEEL.NS', 'TATAMOTORS.NS', 'POWERGRID.NS', 'BAJAJFINSV.NS', 'TATASTEEL.NS', 'COALINDIA.NS', 'INDUSINDBK.NS', 'HINDALCO.NS', 'TECHM.NS', 'GRASIM.NS', 'ADANIPORTS.NS', 'BRITANNIA.NS', 'CIPLA.NS', 'EICHERMOT.NS', 'DRREDDY.NS', 'NESTLEIND.NS', 'HEROMOTOCO.NS', 'BAJAJ-AUTO.NS', 'BPCL.NS', 'SHREECEM.NS', 'TATACONSUM.NS', 'UPL.NS', 'APOLLOHOSP.NS', 'DIVISLAB.NS'];

        const COMPANY_NAMES_GLOBAL = {
            'RELIANCE.NS': 'Reliance Industries', 'TCS.NS': 'Tata Consultancy Services', 'HDFCBANK.NS': 'HDFC Bank', 'ICICIBANK.NS': 'ICICI Bank', 'INFY.NS': 'Infosys', 'HINDUNILVR.NS': 'Hindustan Unilever', 'BHARTIARTL.NS': 'Bharti Airtel', 'ITC.NS': 'ITC Limited', 'SBIN.NS': 'State Bank of India', 'LICI.NS': 'Life Insurance Corp', 'HCLTECH.NS': 'HCL Technologies', 'KOTAKBANK.NS': 'Kotak Mahindra Bank', 'LT.NS': 'Larsen & Toubro', 'BAJFINANCE.NS': 'Bajaj Finance', 'AXISBANK.NS': 'Axis Bank', 'ASIANPAINT.NS': 'Asian Paints', 'MARUTI.NS': 'Maruti Suzuki', 'SUNPHARMA.NS': 'Sun Pharma', 'TITAN.NS': 'Titan Company', 'WIPRO.NS': 'Wipro', 'ULTRACEMCO.NS': 'UltraTech Cement', 'ADANIENT.NS': 'Adani Enterprises', 'ONGC.NS': 'Oil & Natural Gas', 'NTPC.NS': 'NTPC Limited', 'JSWSTEEL.NS': 'JSW Steel', 'TATAMOTORS.NS': 'Tata Motors', 'POWERGRID.NS': 'Power Grid Corp', 'BAJAJFINSV.NS': 'Bajaj Finserv', 'TATASTEEL.NS': 'Tata Steel', 'COALINDIA.NS': 'Coal India', 'INDUSINDBK.NS': 'IndusInd Bank', 'HINDALCO.NS': 'Hindalco Industries', 'TECHM.NS': 'Tech Mahindra', 'GRASIM.NS': 'Grasim Industries', 'ADANIPORTS.NS': 'Adani Ports', 'BRITANNIA.NS': 'Britannia Industries', 'CIPLA.NS': 'Cipla', 'EICHERMOT.NS': 'Eicher Motors', 'DRREDDY.NS': 'Dr. Reddys Labs', 'NESTLEIND.NS': 'Nestle India', 'HEROMOTOCO.NS': 'Hero MotoCorp', 'BAJAJ-AUTO.NS': 'Bajaj Auto', 'BPCL.NS': 'Bharat Petroleum', 'SHREECEM.NS': 'Shree Cement', 'TATACONSUM.NS': 'Tata Consumer', 'UPL.NS': 'UPL Limited', 'APOLLOHOSP.NS': 'Apollo Hospitals', 'DIVISLAB.NS': 'Divis Laboratories'
        };
        // --- End Static Data ---


        function chatApp() {
            // --- Component State ---
            return {
                isLoggedIn: false,
                isLoginView: false,
                isLoading: false,
                email: '',
                password: '',
                confirmPassword: '',
                authError: '',
                currentUser: null,

                mobileSidebarOpen: false,
                isSidebarMinimized: false,
                currentChatId: null,
                chatList: [],
                chatLoading: false,

                // Search State
                searchVisible: false,
                searchQuery: '',
                searchResults: [], // Will store the highlighted <mark> elements
                currentSearchResultIndex: -1,

                portfolioOpen: false,
                portfolioMinimized: false,
                portfolioMaximized: false,
                portfolioTab: 'portfolio',
                portfolio: { cash: 0, holdings: [], summary: {} },
                watchlist: [],
                tradeHistory: [],
                portfolioLoading: false,
                portfolioLastUpdated: null,
                lastUpdatedText: 'never',
                reloadIntervalId: null,


                cashEditModalOpen: false,
                newCashAmount: 0,

                renameModalOpen: false,
                chatToRename: { id: null, title: '' },
                newChatTitle: '',

                stockPickerOpen: false,
                stockPickerMode: 'trade',
                selectedStock: '',
                selectedStocks: [],
                stockSearch: '',
                filteredStocks: NIFTY_50_STOCKS_GLOBAL, // Initialize with global list

                tradeModalOpen: false,
                tradeAction: 'BUY',
                tradeTicker: '',
                tradeQuantity: 1,
                tradeError: '',
                tradeLoading: false,
                currentStockPrice: 0,
                totalTradeValue: 0,
                loadingPrice: false,

                async init() {
                    await this.initFirebase();
                },

                async initFirebase() {
                    await new Promise(resolve => {
                        const checkFirebase = setInterval(() => {
                            if (window.firebaseAuth && window.firebaseAuthFunctions) {
                                clearInterval(checkFirebase);
                                resolve();
                            }
                        }, 50);
                    });

                    const { onAuthStateChanged, setPersistence, browserLocalPersistence } = window.firebaseAuthFunctions;
                    await setPersistence(window.firebaseAuth, browserLocalPersistence);

                    onAuthStateChanged(window.firebaseAuth, user => {
                        if (user) {
                            this.isLoggedIn = true;
                            this.currentUser = user;
                            this.loadInitialData();
                        } else {
                            this.isLoggedIn = false;
                            this.currentUser = null;
                            if (this.reloadIntervalId) clearInterval(this.reloadIntervalId);
                        }
                        document.body.classList.remove('auth-loading');
                    });
                },

                async loadInitialData() {
                    await this.fetchChatList();
                    if (this.chatList.length > 0) {
                        this.loadChat(this.chatList[0].chatId, true);
                    } else {
                        this.startNewChat(true);
                    }
                },

                async getProactiveAlert() {
                    console.log("Checking for proactive alerts...");
                    // Placeholder for future implementation
                },

                async handleSignup() {
                    if (this.password !== this.confirmPassword) {
                        this.authError = "Passwords do not match";
                        return;
                    }
                    this.isLoading = true;
                    this.authError = '';
                    try {
                        await window.firebaseAuthFunctions.createUserWithEmailAndPassword(window.firebaseAuth, this.email, this.password);
                    } catch (error) {
                        this.authError = error.message.replace('Firebase: ', '');
                    } finally {
                        this.isLoading = false;
                    }
                },

                async handleLogin() {
                    this.isLoading = true;
                    this.authError = '';
                    try {
                        await window.firebaseAuthFunctions.signInWithEmailAndPassword(window.firebaseAuth, this.email, this.password);
                    } catch (error) {
                        this.authError = error.message.replace('Firebase: ', '');
                    } finally {
                        this.isLoading = false;
                    }
                },

                async handleLogout() {
                    await window.firebaseAuthFunctions.signOut(window.firebaseAuth);
                },

                async fetchChatList() {
                    if (!this.currentUser) return;
                    try {
                        const response = await fetch(`${API_BASE_URL}/api/chats/${this.currentUser.uid}`);
                        if (response.ok) this.chatList = await response.json();
                    } catch (error) {
                        console.error("Error fetching chat list:", error);
                    }
                },

                async loadChat(chatId, showAlert = false) {
                    this.currentChatId = chatId
                    this.chatLoading = true
                    this.clearSearch() // Clear search when loading a new chat
                    this.searchVisible = false // Hide search bar when loading new chat

                    // Find and update chat title
                    const chat = this.chatList.find(c => c.chatId === chatId)
                    document.getElementById('chat-title').textContent = chat ? chat.title : 'Chat'

                    // CRITICAL FIX: Clear container FIRST, then set loading
                    const container = document.getElementById('message-container')
                    container.innerHTML = '' // Clear immediately

                    if (showAlert) await this.getProactiveAlert()

                    try {
                        const response = await fetch(`${API_BASE_URL}/api/chat/${this.currentUser.uid}/${chatId}`)
                        if (response.ok) {
                            const messages = await response.json()
                            // Clear again just before appending to ensure no duplicates
                            container.innerHTML = ''
                            messages.forEach(msg => this.appendMessage(msg.text, msg.role, false))
                        }
                    } catch (error) {
                        console.error('Error loading messages:', error)
                    } finally {
                        this.chatLoading = false
                        this.scrollToBottom()
                        this.mobileSidebarOpen = false
                    }
                },

                async startNewChat(showAlert = false) {
                    this.currentChatId = null;
                    this.clearSearch(); // Clear search for new chat
                    this.searchVisible = false; // Hide search bar for new chat
                    document.getElementById('chat-title').textContent = "New Chat";
                    document.getElementById('message-container').innerHTML = '';

                    if (showAlert) await this.getProactiveAlert();

                    this.appendMessage("Hello! I'm your AI Stock Analyst. How can I help you today?", 'agent');
                    this.$nextTick(() => document.getElementById('message-input')?.focus());
                },

                async deleteChat(chatId) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/api/chat/${this.currentUser.uid}/${chatId}`, { method: 'DELETE' });
                        if (response.ok) {
                            await this.fetchChatList();
                            if (this.currentChatId === chatId) {
                                if (this.chatList.length > 0) {
                                    this.loadChat(this.chatList[0].chatId);
                                } else {
                                    this.startNewChat();
                                }
                            }
                        }
                    } catch (e) {
                        this.appendMessage('Error: Could not delete chat.', 'system');
                    }
                },

                openRenameModal(chatId, currentTitle) {
                    this.chatToRename.id = chatId;
                    this.chatToRename.title = currentTitle;
                    this.newChatTitle = currentTitle;
                    this.renameModalOpen = true;
                    this.$nextTick(() => this.$refs.renameInput.focus());
                },

                async submitRename() {
                    if (!this.newChatTitle || !this.chatToRename.id || this.newChatTitle.trim() === '') return;

                    try {
                        const response = await fetch(`${API_BASE_URL}/api/chat/${this.currentUser.uid}/${this.chatToRename.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ title: this.newChatTitle.trim() })
                        });
                        if (response.ok) {
                            await this.fetchChatList();
                            if (this.currentChatId === this.chatToRename.id) {
                                document.getElementById('chat-title').textContent = this.newChatTitle.trim();
                            }
                        }
                    } catch (e) {
                        this.appendMessage('Error: Could not rename chat.', 'system');
                    } finally {
                        this.renameModalOpen = false;
                    }
                },


                async sendMessage() {
                    const input = document.getElementById('message-input');
                    const message = input.value.trim();
                    if (!message) return;

                    this.appendMessage(message, 'user');
                    input.value = '';
                    this.autoResize(input);

                    const typingId = Date.now();
                    this.appendTypingIndicator(typingId);

                    const sendButton = document.getElementById('send-button');
                    if (sendButton) sendButton.disabled = true;
                    if (input) input.disabled = true;

                    try {
                        const response = await fetch(`${API_BASE_URL}/api/chat`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                userId: this.currentUser.uid,
                                chatId: this.currentChatId,
                                message: message
                            })
                        });

                        const data = await response.json();
                        document.getElementById(`typing-${typingId}`)?.remove();

                        if (response.ok) {
                            this.appendMessage(data.reply, 'agent');
                            if (!this.currentChatId && data.chatId) {
                                this.currentChatId = data.chatId;
                                await this.fetchChatList();
                                const newChat = this.chatList.find(c => c.chatId === data.chatId);
                                if (newChat) document.getElementById('chat-title').textContent = newChat.title;
                            }
                        } else {
                            this.appendMessage(`Sorry, an error occurred: ${data.error || 'Unknown error'}`, 'system');
                        }
                    } catch (error) {
                        document.getElementById(`typing-${typingId}`)?.remove();
                        this.appendMessage('Network error. Please try again.', 'system');
                    } finally {
                        if (sendButton) sendButton.disabled = false;
                        if (input) {
                            input.disabled = false;
                            input.focus();
                        }
                    }
                },

                appendMessage(text, sender, animate = true) {
                    const container = document.getElementById('message-container');
                    const div = document.createElement('div');

                    let senderClass = 'message-agent';
                    if (sender === 'user') senderClass = 'message-user';
                    if (sender === 'system') senderClass = 'message-system';

                    div.className = `${animate ? 'message' : ''} flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

                    let content = `<p class="text-sm whitespace-pre-wrap">${text}</p>`;

                    if (sender === 'system') {
                        content = `<div class="flex items-start gap-3">
                         <div class="flex-shrink-0"><svg class="w-5 h-5 text-amber-300" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg></div>
                         <p class="text-sm whitespace-pre-wrap">${text}</p>
                        </div>`;
                    }

                    div.innerHTML = `<div class="${senderClass} px-4 py-3 max-w-[85%] sm:max-w-[80%] shadow-lg">${content}</div>`;

                    container.appendChild(div);
                    this.scrollToBottom();
                },

                appendTypingIndicator(id) {
                    const container = document.getElementById('message-container');
                    const div = document.createElement('div');
                    div.id = `typing-${id}`;
                    div.className = 'message flex justify-start';
                    div.innerHTML = `
                  <div class="message-agent px-4 py-3 shadow-lg">
                      <div class="flex gap-1">
                          <div class="w-2 h-2 bg-slate-500 rounded-full typing-dot"></div>
                          <div class="w-2 h-2 bg-slate-500 rounded-full typing-dot"></div>
                          <div class="w-2 h-2 bg-slate-500 rounded-full typing-dot"></div>
                      </div>
                  </div>
                `;
                    container.appendChild(div);
                    this.scrollToBottom();
                },

                scrollToBottom() {
                    const chatWindow = document.getElementById('chat-window');
                    if (chatWindow) {
                        this.$nextTick(() => {
                            chatWindow.scrollTop = chatWindow.scrollHeight;
                        });
                    }
                },

                autoResize(textarea) {
                    textarea.style.height = 'auto';
                    textarea.style.height = Math.min(textarea.scrollHeight, 128) + 'px';
                },

                // --- NEW SEARCH FUNCTIONS ---
                toggleSearch() {
                    this.searchVisible = !this.searchVisible;
                    if (this.searchVisible) {
                        // Focus the input when search bar opens
                        this.$nextTick(() => this.$refs.searchInput.focus());
                    } else {
                        this.clearSearch(); // Clear search when closing
                    }
                },

                clearHighlights() {
                    // Find all message paragraphs and reset their content to plain text
                    document.querySelectorAll('#message-container p').forEach(p => {
                        // Check if the parent div has one of the message classes before resetting
                        const parentDiv = p.closest('div[class*="message-"]');
                        if (parentDiv && (parentDiv.classList.contains('message-agent') ||
                            parentDiv.classList.contains('message-user') ||
                            parentDiv.classList.contains('message-system'))) {
                            p.innerHTML = p.innerText;
                        }
                    });
                },

                performSearch() {
                    this.clearHighlights();
                    this.searchResults = [];
                    this.currentSearchResultIndex = -1;

                    // Don't search for empty or very short strings
                    if (!this.searchQuery || this.searchQuery.length < 1) { // Allow single character searches now if needed, but only whole word
                        return;
                    }

                    const query = this.searchQuery.toLowerCase();
                    // Select all <p> tags inside message bubbles
                    const messageParagraphs = document.querySelectorAll('.message-agent p, .message-user p');
                    const regex = new RegExp(`\\b${this.searchQuery.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')}\\b`, 'gi');


                    let results = [];
                    messageParagraphs.forEach(p => {
                        const text = p.innerText;

                        if (regex.test(text)) {

                            p.innerHTML = text.replace(regex, match => `<mark class="search-highlight">${match}</mark>`);

                            results.push(...p.querySelectorAll('mark.search-highlight'));
                        }

                        regex.lastIndex = 0;
                    });

                    this.searchResults = results;

                    if (this.searchResults.length > 0) {
                        this.currentSearchResultIndex = 0;
                        this.highlightCurrentResult();
                    }
                },

                highlightCurrentResult() {
                    // Remove 'active' from all highlights
                    this.searchResults.forEach(mark => mark.classList.remove('active'));

                    if (this.currentSearchResultIndex > -1 && this.searchResults[this.currentSearchResultIndex]) {
                        const currentMark = this.searchResults[this.currentSearchResultIndex];
                        currentMark.classList.add('active');

                        // Scroll to the active highlight
                        currentMark.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });
                    }
                },

                navigateSearch(direction) {
                    if (this.searchResults.length === 0) return;

                    if (direction === 'next') {
                        this.currentSearchResultIndex++;
                        if (this.currentSearchResultIndex >= this.searchResults.length) {
                            this.currentSearchResultIndex = 0; // Wrap around to start
                        }
                    } else if (direction === 'prev') {
                        this.currentSearchResultIndex--;
                        if (this.currentSearchResultIndex < 0) {
                            this.currentSearchResultIndex = this.searchResults.length - 1; // Wrap around to end
                        }
                    }
                    this.highlightCurrentResult();
                },

                clearSearch() {
                    this.clearHighlights();
                    this.searchQuery = '';
                    this.searchResults = [];
                    this.currentSearchResultIndex = -1;
                },
                // --- END NEW SEARCH FUNCTIONS ---

                openPortfolio() {
                    this.portfolioOpen = true;
                    this.portfolioMinimized = false;
                    this.portfolioTab = 'portfolio'; // Default to portfolio tab
                    this.loadPortfolio();
                },

                async loadPortfolio() {
                    if (!this.currentUser) return;

                    this.portfolioLoading = true;
                    if (this.reloadIntervalId) clearInterval(this.reloadIntervalId);

                    try {
                        const response = await fetch(`${API_BASE_URL}/api/portfolio/${this.currentUser.uid}`);
                        if (response.ok) {
                            this.portfolio = await response.json();
                            this.portfolioLastUpdated = Date.now();
                            this.updateLastUpdatedText(); // Initial update
                            this.reloadIntervalId = setInterval(() => this.updateLastUpdatedText(), 1000);
                        }
                    } catch (error) {
                        console.error('❌ Portfolio error:', error);
                        this.lastUpdatedText = 'Error';
                    } finally {
                        this.portfolioLoading = false;
                    }
                },

                updateLastUpdatedText() {
                    if (!this.portfolioLastUpdated) {
                        this.lastUpdatedText = 'never';
                        return;
                    }
                    const seconds = Math.floor((Date.now() - this.portfolioLastUpdated) / 1000);
                    if (seconds < 5) {
                        this.lastUpdatedText = 'Updated just now';
                    } else if (seconds < 60) {
                        this.lastUpdatedText = `Updated ${seconds} sec ago`;
                    } else {
                        this.lastUpdatedText = `Updated ${Math.floor(seconds / 60)} min ago`;
                    }
                },

                async loadWatchlistPrices() {
                    if (!this.currentUser) return;
                    this.portfolioLoading = true;
                    try {
                        const response = await fetch(`${API_BASE_URL}/api/watchlist/${this.currentUser.uid}`);
                        if (response.ok) {
                            this.watchlist = await response.json();
                        } else {
                            console.error('Failed to load watchlist prices:', response.status);
                        }
                    } catch (error) {
                        console.error('❌ Watchlist error:', error);
                    } finally {
                        this.portfolioLoading = false;
                    }
                },

                async loadTradeHistory() {
                    if (!this.currentUser) return;
                    this.portfolioLoading = true;
                    try {
                        const response = await fetch(`${API_BASE_URL}/api/history/${this.currentUser.uid}`);
                        if (response.ok) {
                            this.tradeHistory = await response.json();
                        } else {
                            console.error('Failed to load trade history');
                            this.tradeHistory = [];
                        }
                    } catch (error) {
                        console.error('❌ History error:', error);
                        this.tradeHistory = [];
                    } finally {
                        this.portfolioLoading = false;
                    }
                },

                formatTradeTimestamp(isoString) {
                    if (!isoString) return 'N/A';
                    const date = new Date(isoString);
                    // Attempt to handle both UTC ('Z') and potentially server-local times
                    if (isoString.endsWith('Z')) {
                        // If it's UTC, format it nicely for India time
                        return date.toLocaleString('en-IN', {
                            day: 'numeric', month: 'short', year: 'numeric',
                            hour: 'numeric', minute: '2-digit', hour12: true, timeZone: 'Asia/Kolkata'
                        });
                    } else {
                        // Otherwise, assume it's already in a local-ish time and format directly
                        return date.toLocaleString('en-IN', {
                            day: 'numeric', month: 'short', year: 'numeric',
                            hour: 'numeric', minute: '2-digit', hour12: true
                        });
                    }
                },

                openCashEditModal() {
                    this.newCashAmount = this.portfolio.cash;
                    this.cashEditModalOpen = true;
                },

                async adjustCash() {
                    if (this.newCashAmount < 0 || this.newCashAmount > 1000000) return;
                    try {
                        const response = await fetch(`${API_BASE_URL}/api/adjust-cash/${this.currentUser.uid}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ cash: this.newCashAmount })
                        });

                        if (response.ok) {
                            this.cashEditModalOpen = false;
                            await this.loadPortfolio();
                        }
                    } catch (error) {
                        console.error("Cash adjustment error:", error);
                    }
                },

                openStockPicker(mode) {
                    this.stockPickerMode = mode;
                    this.stockPickerOpen = true;
                    this.selectedStock = '';
                    this.selectedStocks = [];
                    this.stockSearch = '';
                    this.filteredStocks = NIFTY_50_STOCKS_GLOBAL;
                    // this.filterStocks(); // No need to call filter initially if showing all
                },

                filterStocks() {
                    const search = this.stockSearch.toLowerCase();
                    if (!search) {
                        this.filteredStocks = NIFTY_50_STOCKS_GLOBAL;
                        return;
                    }
                    this.filteredStocks = NIFTY_50_STOCKS_GLOBAL.filter(stock =>
                        stock.toLowerCase().includes(search) || (COMPANY_NAMES_GLOBAL[stock] && COMPANY_NAMES_GLOBAL[stock].toLowerCase().includes(search))
                    );
                },

                toggleStockSelection(stock) {
                    if (this.stockPickerMode === 'trade') {
                        this.selectedStock = this.selectedStock === stock ? '' : stock;
                    } else {
                        const index = this.selectedStocks.indexOf(stock);
                        if (index > -1) {
                            this.selectedStocks.splice(index, 1);
                        } else {
                            this.selectedStocks.push(stock);
                        }
                    }
                    // Force Alpine update if needed (often not necessary with array pushes/splices)
                    // this.$forceUpdate(); 
                },

                isStockSelected(stock) {
                    return this.stockPickerMode === 'trade' ? this.selectedStock === stock : this.selectedStocks.includes(stock);
                },

                getCompanyName(ticker) {
                    return COMPANY_NAMES_GLOBAL[ticker] || ticker;
                },

                async proceedWithSelection() {
                    if (this.stockPickerMode === 'trade' && this.selectedStock) {
                        this.openTradeModal('BUY', this.selectedStock, 1); // Default quantity to 1
                        this.stockPickerOpen = false;
                    } else if (this.stockPickerMode === 'watchlist' && this.selectedStocks.length > 0) {
                        this.isLoading = true; // Use global loading indicator maybe? Or specific?
                        try {
                            const response = await fetch(`${API_BASE_URL}/api/watchlist/${this.currentUser.uid}`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ tickers: this.selectedStocks })
                            });

                            if (response.ok) {
                                this.selectedStocks = [];
                                this.stockPickerOpen = false;
                                await this.loadWatchlistPrices(); // Reload watchlist after adding
                                // Switch portfolio view to watchlist?
                                this.portfolioTab = 'watchlist';
                            } else {
                                const errorData = await response.json();
                                this.appendMessage(`Error adding to watchlist: ${errorData.message || errorData.error}`, 'system');
                            }
                        } catch (error) {
                            console.error("Watchlist add error:", error);
                            this.appendMessage('Network error while adding to watchlist.', 'system');
                        } finally {
                            this.isLoading = false;
                        }
                    }
                },

                async removeFromWatchlist(ticker) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/api/watchlist/${this.currentUser.uid}/${ticker}`, {
                            method: 'DELETE'
                        });
                        if (response.ok) {
                            await this.loadWatchlistPrices(); // Reload watchlist after removing
                        } else {
                            console.error("Failed to remove from watchlist");
                        }
                    } catch (error) {
                        console.error("Watchlist remove error:", error);
                    }
                },

                async openTradeModal(action, ticker, quantity) {
                    this.tradeAction = action;
                    this.tradeTicker = ticker;
                    this.tradeQuantity = quantity || 1; // Ensure quantity is valid
                    this.tradeError = '';
                    this.loadingPrice = true;
                    this.tradeModalOpen = true;
                    this.currentStockPrice = 0; // Reset price to 0 initially
                    this.totalTradeValue = 0;   // Reset total to 0

                    try {
                        const response = await fetch(`${API_BASE_URL}/api/stock/price/${ticker}`);
                        if (!response.ok) {
                            const errData = await response.json();
                            throw new Error(errData.error || `HTTP error! status: ${response.status}`);
                        }
                        const data = await response.json();

                        // --- FIX: Use current_price ---
                        if (data && data.current_price !== undefined) {
                            this.currentStockPrice = data.current_price;
                        } else if (data && data.error) {
                            throw new Error(data.error);
                        } else {
                            throw new Error('Invalid price data received.');
                        }
                        // --- END FIX ---

                        this.calculateTradeValue(); // Calculate AFTER getting the price
                    } catch (error) {
                        console.error("Error in openTradeModal:", error);
                        this.tradeError = error.message || 'Failed to fetch price';
                        this.currentStockPrice = 0; // Set to 0 on error
                        this.calculateTradeValue(); // Recalculate (will be 0)
                    } finally {
                        this.loadingPrice = false;
                    }
                },

                calculateTradeValue() {
                    // Ensure tradeQuantity is a positive number, default to 0 if not
                    const quantity = (typeof this.tradeQuantity === 'number' && this.tradeQuantity > 0) ? this.tradeQuantity : 0;
                    // Calculate value, ensuring price is also valid
                    const price = (typeof this.currentStockPrice === 'number' && this.currentStockPrice >= 0) ? this.currentStockPrice : 0;
                    // Use Math.round for better handling of potential floating point issues
                    this.totalTradeValue = Math.round(price * quantity * 100) / 100; // Round to 2 decimal places
                },


                async executeTrade() {
                    this.tradeLoading = true;
                    this.tradeError = '';
                    // Validate quantity client-side first
                    if (!Number.isInteger(this.tradeQuantity) || this.tradeQuantity <= 0) {
                        this.tradeError = "Quantity must be a positive whole number.";
                        this.tradeLoading = false;
                        return;
                    }

                    try {
                        const response = await fetch(`${API_BASE_URL}/api/trade/${this.currentUser.uid}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                ticker: this.tradeTicker,
                                quantity: this.tradeQuantity,
                                action: this.tradeAction
                            })
                        });

                        const data = await response.json();

                        if (response.ok && data.success) { // Check for success flag from backend
                            this.tradeModalOpen = false;
                            await this.loadPortfolio(); // Reload portfolio data
                        } else {
                            // Use the specific error message from the backend if available
                            this.tradeError = data.message || data.error || 'Trade failed. Please check details.';
                        }
                    } catch (error) {
                        console.error("Trade execution error:", error);
                        this.tradeError = 'Network error during trade execution.';
                    } finally {
                        this.tradeLoading = false;
                    }
                }
            } // End of return object
        } // End of chatApp function
    </script>
</body>

</html>